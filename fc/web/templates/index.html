<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>FootballChamp - Predizioni</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="icon" href="/assets/icon.jpg" type="image/x-icon">
</head>
<body>
  <div class="container">
    <h1>Football Champ</h1>
    <p>Inserisci una partita (data, casa, trasferta) e aggiungila alla lista. Poi clicca Predici.</p>

    <div class="card">
      <div class="form-row">
        <label>Data</label>
        <input type="date" id="date" />
      </div>
      <div class="form-row">
        <label>Casa</label>
        <input type="text" id="home_team" placeholder="Inter" />
      </div>
      <div class="form-row">
        <label>Trasferta</label>
        <input type="text" id="away_team" placeholder="Milan" />
      </div>

      <details class="details">
        <summary>Quote opzionali (PSCH/PSCD/PSCA)</summary>
        <div class="grid-3">
          <input type="number" step="0.01" id="psch" placeholder="PSCH (es. 1.85)" />
          <input type="number" step="0.01" id="pscd" placeholder="PSCD (es. 3.50)" />
          <input type="number" step="0.01" id="psca" placeholder="PSCA (es. 4.20)" />
        </div>
      </details>

      <div class="actions">
        <button id="addBtn">Aggiungi partita</button>
        <button id="predictBtn" class="primary">Predici</button>
        <button id="recalcBtn">Ricalcola</button>
      </div>
    </div>

    <div class="card">
      <h2>Partite</h2>
      <table id="fixturesTable">
        <thead>
          <tr>
            <th>
              Data
            </th>
            <th>
              Casa
            </th>
            <th>
              Trasferta
            </th>
            <th>
              Azioni
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Predizioni</h2>
      <table id="predsTable">
        <thead>
          <tr>
            <th>Data</th><th>Casa</th><th>Trasferta</th>
            <th>Prob. 1X2</th>
            <th>λ</th>
            <th>Doppia chance</th>
            <th>Over/BTTS</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const fixtures = [];
    const tbody = document.querySelector("#fixturesTable tbody");
    const predsTbody = document.querySelector("#predsTable tbody");

    function pct(x) {
      if (x === null || isNaN(x)) return "-";

      return Math.round(x * 100) + '%';
    }

    function fair(x) {
      if (!x || x <= 0) return "-";

      return (1 / x).toFixed(2);
    }

    function tone(p) {
      if (p >= 0.65) return "hi";
      if (p >= 0.55) return "mid";

      return "lo";
    }

    function chip(label, p) {
      return `<span class="badge ${tone(p)}"><strong>${label}</strong>${pct(p)}</span>`;
    }

    function lambdasChip(lh, la) {
      return `<span class="badge"><strong>λ H</strong>${lh.toFixed(2)}</span>
              <span class="badge"><strong>λ A</strong>${la.toFixed(2)}</span>`;
    }

    function bar1x2(p1, px, p2) {
      const w1 = Math.round(p1 * 100);
      const wx = Math.round(px * 100);
      const w2 = Math.round(p2 * 100);

      const minWidth = 2;
      const adjustedW1 = w1 > 0 ? Math.max(w1, minWidth) : 0;
      const adjustedWx = wx > 0 ? Math.max(wx, minWidth) : 0;
      const adjustedW2 = w2 > 0 ? Math.max(w2, minWidth) : 0;

      return `
        <div class="bar">
          <span class="seg home" style="width: ${adjustedW1}%"></span>
          <span class="seg draw" style="width: ${adjustedWx}%"></span>
          <span class="seg away" style="width: ${adjustedW2}%"></span>
        </div>
        <div class="bar-legend">
          <span>1 ${pct(p1)}</span> <span>X ${pct(px)}</span> <span>2 ${pct(p2)}</span>
        </div>
      `;
    }

    function renderFixtures() {
      tbody.innerHTML = "";
      fixtures.forEach((f, i) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${f.date || ""}</td>
          <td>${f.home_team || ""}</td>
          <td>${f.away_team || ""}</td>
          <td><button data-i="${i}" class="remove">Rimuovi</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button.remove").forEach(btn => {
        btn.onclick = () => {
          fixtures.splice(parseInt(btn.dataset.i), 1);
          renderFixtures();
        };
      });
    }

    document.getElementById("addBtn").onclick = () => {
      const date = document.getElementById("date").value;
      const home_team = document.getElementById("home_team").value.trim();
      const away_team = document.getElementById("away_team").value.trim();
      const psch = document.getElementById("psch").value;
      const pscd = document.getElementById("pscd").value;
      const psca = document.getElementById("psca").value;
      if (!date || !home_team || !away_team) return alert("Compila data, casa e trasferta.");

      const rec = { date, home_team, away_team };
      if (psch) rec.psch = parseFloat(psch);
      if (pscd) rec.pscd = parseFloat(pscd);
      if (psca) rec.psca = parseFloat(psca);

      fixtures.push(rec);
      renderFixtures();
    };

    async function predictCurrent() {
      if (!fixtures.length) {
        alert("Aggiungi almeno una partita.");
        return;
      }
      predsTbody.innerHTML = "<tr><td colspan='7'>Calcolo...</td></tr>";
      const res = await fetch("/api/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fixtures })
      });
      if (!res.ok) {
        predsTbody.innerHTML = "<tr><td colspan='7'>Errore nella predizione</td></tr>";
        return;
      }
      const data = await res.json();
      predsTbody.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        const dc = `${chip("1X", r.p_1x)} ${chip("12", r.p_12)} ${chip("X2", r.p_x2)}`;
        const over = `${chip("Over 1.5", r.p_over_1_5)} ${chip("Over 2.5", r.p_over_2_5)}
                      ${chip("BTTS", r.p_btts_yes)} ${chip("H ≥ 1", r.p_home_scores)} ${chip("A ≥ 1", r.p_away_scores)}`;
        const notes = [];
        if (r.explain_market_estimated) notes.push('<span class="badge lo">quote stimate</span>');
        if (r.explain_draw_boosted) notes.push('<span class="badge mid">draw boost</span>');
        if (r.explain_near_tie_promoted) notes.push('<span class="badge mid">near-tie</span>');
        if (r.explain_guardrails_applied) notes.push('<span class="badge lo">guardrails</span>');
        tr.innerHTML = `
          <td>${(r.date || "").split("T")[0]}</td>
          <td>${r.home_team}</td>
          <td>${r.away_team}</td>
          <td>${bar1x2(r.p_home, r.p_draw, r.p_away)}</td>
          <td class="badges">${lambdasChip(r.lambda_home, r.lambda_away)}</td>
          <td class="badges">${dc}</td>
          <td class="badges">${over}</td>
          <td class="badges">${notes.join(' ')}</td>
        `;
        predsTbody.appendChild(tr);
      });
    }

    document.getElementById("predictBtn").onclick = predictCurrent;
    document.getElementById("recalcBtn").onclick = predictCurrent;
  </script>
</body>
</html>
